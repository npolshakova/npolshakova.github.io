<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <title>I'm a teapot &#8211; </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <meta name="author" content="Nina Polshakova">
  <link rel="author" href="https://npolshakova.github.io/" title="Nina Polshakova" />
  <meta name="description" content="">
  <meta name="keywords" content="">
  <meta name="viewport" content="width=device-width">
  <link rel="canonical" href="http://localhost:8080/2024/01/08/tea.html" />
  <link rel="shortcut icon" href="https://avatars.githubusercontent.com/u/15183287?v=4" />

  <meta property="og:title" content="I'm a teapot &#8211; ">
  <meta property="og:type" content="article">
  <meta property="og:description" content="">
  <meta property="og:url" content="http://localhost:8080/2024/01/08/tea.html">
  <meta property="og:site_name" content="">
  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:creator" content="@NPolshakova">
  <meta name="twitter:title" content="I'm a teapot &#8211; ">
  <meta name="twitter:description" content="">
  

  <link href="http://localhost:8080/feed.xml" type="application/atom+xml" rel="alternate" title="">

  <link rel="stylesheet" href="/css/main.min.css">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">
</head>

<body>
  <input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<div class="sidebar" id="sidebar">
<div class="sidebar-item"> 
	<p>I write stuff here.</p> 
</div> 

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
    
      
    
      
    
      
    
      
    

  </nav>

  <div class="sidebar-item">
    <p>
    </p>
    <p class="social-icons">
      <a href="https://twitter.com/NPolshakova"><i class="fab fa-twitter fa-2x"></i></a>
      <a href="https://www.linkedin.com/in/nina-polshakova/"><i class="fab fa-linkedin-in fa-2x"></i></a>
      <a href="https://github.com/npolshakova"><i class="fab fa-github fa-2x"></i></a>
      <a href="/feed.xml"><i class="fa fa-rss fa-2x"></i></a>
    </p>
    <p>
     Nina Polshakova &copy; 2024.
    </p>
  </div>
</div>


  <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
       content to avoid any CSS collisions with our real content. -->
  <div class="wrap">
    <div class="masthead">
      <div class="container">
        <h3 class="masthead-title">
          <a href="/" title="Home"></a>
          <small>I write stuff here.</small>
        </h3>
      </div>
    </div>

    <div class="container content">
      <article itemscope itemtype="http://schema.org/Article">
  <div class="post">
    <h2 itemprop="name" class="post-title">I'm a teapot</h2>
    <p class="entry-tags"></p>
    <!--    <p class="post-date" itemprop="datePublished" content="2024-01-08">08 Jan 2024</p> -->
    
    <p>January 08, 2024</p>
<div class="my-custom-div" style="background-size: 236px 296px; width: 236px; height: 175px; background-image: url('https://www.gstatic.com/teapot/teapot_2x.png');">
</div>

<hr />

<p>I love tea… It’s not only my prefered source of caffine, it’s also a good excuse to have tiny sandwiches and pastries like this excessive high tea I had at the Delft Blue Museum:</p>

<p><img src="/assets/tea.jpg" /></p>

<p>Maybe because of my tea addiction, one of my favorite “easter eggs” in networking is the 418 status code. The teapot from earlier was actually from Google’s <a href="https://www.google.com/teapot">teapot page</a>. If you curl it with the <code class="language-plaintext highlighter-rouge">-v</code> (verbose) flag you’ll actually get (a very secure) <code class="language-plaintext highlighter-rouge">418</code> response back:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ curl https://www.google.com/teapot -v
* Host www.google.com:443 was resolved.
* IPv6: 2607:f8b0:4005:814::2004
* IPv4: 142.251.46.164
*   Trying [2607:f8b0:4005:814::2004]:443...
* Connected to www.google.com (2607:f8b0:4005:814::2004) port 443
* ALPN: curl offers h2,http/1.1
* TLSv1.3 (OUT), TLS handshake, Client hello (1):
* TLSv1.3 (IN), TLS handshake, Server hello (2):
* TLSv1.3 (IN), TLS handshake, Encrypted Extensions (8):
* TLSv1.3 (IN), TLS handshake, Certificate (11):
* TLSv1.3 (IN), TLS handshake, CERT verify (15):
* TLSv1.3 (IN), TLS handshake, Finished (20):
* TLSv1.3 (OUT), TLS change cipher, Change cipher spec (1):
* TLSv1.3 (OUT), TLS handshake, Finished (20):
* SSL connection using TLSv1.3 / TLS_AES_256_GCM_SHA384 / x25519 / id-ecPublicKey
* ALPN: server accepted h2
* Server certificate:
*  subject: CN=www.google.com
*  start date: Nov 20 08:09:47 2023 GMT
*  expire date: Feb 12 08:09:46 2024 GMT
*  subjectAltName: host "www.google.com" matched cert's "www.google.com"
*  issuer: C=US; O=Google Trust Services LLC; CN=GTS CA 1C3
*  SSL certificate verify ok.
*   Certificate level 0: Public key type EC/prime256v1 (256/128 Bits/secBits), signed using sha256WithRSAEncryption
*   Certificate level 1: Public key type RSA (2048/112 Bits/secBits), signed using sha256WithRSAEncryption
*   Certificate level 2: Public key type RSA (4096/152 Bits/secBits), signed using sha384WithRSAEncryption
* using HTTP/2
* [HTTP/2] [1] OPENED stream for https://www.google.com/teapot
* [HTTP/2] [1] [:method: GET]
* [HTTP/2] [1] [:scheme: https]
* [HTTP/2] [1] [:authority: www.google.com]
* [HTTP/2] [1] [:path: /teapot]
* [HTTP/2] [1] [user-agent: curl/8.5.0]
* [HTTP/2] [1] [accept: */*]
&gt; GET /teapot HTTP/2
&gt; Host: www.google.com
&gt; User-Agent: curl/8.5.0
&gt; Accept: */*
&gt;
* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
* old SSL session ID is stale, removing
&lt; HTTP/2 418
</code></pre></div></div>

<p>If you keep digging down this teapot rabbit hole, there’s also an http version of the teapot page (<code class="language-plaintext highlighter-rouge">http://www.google.com/teapot</code>) that you can hit as well. However this still uses HTTP/1.1 so you’ll get a slightly different response back:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ curl http://www.google.com/teapot -v
* Host www.google.com:80 was resolved.
* IPv6: 2607:f8b0:4005:814::2004
* IPv4: 142.251.46.164
*   Trying [2607:f8b0:4005:814::2004]:80...
* Connected to www.google.com (2607:f8b0:4005:814::2004) port 80
&gt; GET /teapot HTTP/1.1
&gt; Host: www.google.com
&gt; User-Agent: curl/8.5.0
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 418 I'm a Teapot
</code></pre></div></div>

<p>The same behavior happens when you hit <code class="language-plaintext highlighter-rouge">http://httpbin.org/status/418</code> vs <code class="language-plaintext highlighter-rouge">http://httpbin.org/status/418</code> except you get a cute ascii teapot in the response body:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ curl http://httpbin.org/status/418 -v
* Host httpbin.org:80 was resolved.
* IPv6: (none)
* IPv4: 44.197.233.190, 3.224.157.95, 184.73.216.86, 52.206.94.89
*   Trying 44.197.233.190:80...
* Connected to httpbin.org (44.197.233.190) port 80
&gt; GET /status/418 HTTP/1.1
&gt; Host: httpbin.org
&gt; User-Agent: curl/8.5.0
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 418 I'M A TEAPOT
&lt; Date: Mon, 08 Jan 2024 20:14:54 GMT
&lt; Content-Length: 135
&lt; Connection: keep-alive
&lt; Server: gunicorn/19.9.0
&lt; x-more-info: http://tools.ietf.org/html/rfc2324
&lt; Access-Control-Allow-Origin: *
&lt; Access-Control-Allow-Credentials: true
&lt;

    -=[ teapot ]=-

       _...._
     .'  _ _ `.
    | ."` ^ `". _,
    \_;`"---"`|//
      |       ;/
      \_     _/
        `"""`
</code></pre></div></div>

<p>One thing you might notice is the text in the HTTP/1.1 protocols is slightly different (Google’s calm, adult “I’m a Teapot” vs. httpbin’s aggressive “I’M A TEAPOT”). The reason for this different is you can actually set the <a href="https://www.iana.org/assignments/http-status-codes/http-status-codes.xhtml">available http status codes</a> to whatever you want in HTTP/1.1. However in HTTP/2.2 the 418 status code is now dedicated as <a href="https://www.rfc-editor.org/rfc/rfc9110.html#section-15.5.19">unused</a> but not assignable since so many people have been using the 418 for testing and it exists else where in the wild (See the <a href="https://save418.com/">Save 418 Movement</a>).</p>

<p>So how what does 418 have to do with teapots? Backstory time…</p>

<p>The HTTP <code class="language-plaintext highlighter-rouge">418: I'm a teapot</code> client error response code comes from an April Fool’s joke. In 1998, <a href="https://datatracker.ietf.org/doc/html/rfc2324">RFC 2324</a> defined a communication protocol called Hyper Text Coffee Pot Control Protocol (HTCPCP/1.0) designed for “controlling, monitoring and diagnosing coffee pots”. Logically any attempt to brew coffee with a teapot should result in the error code “418 I’m a teapot”. There have even been implementations of the HTCPC protocol such as http://error418.net/ (although they intentionally use a teapot and raspberry pi instead of a coffee pot to highlight the 418 response).</p>

<p>Well, back in October 2023, Marino Wijay and I had some fun hacking with Istio and Raspberry Pis as part of Kubecon NA’s colocated event, Kubernetes on Edge Day. Our talk was aptly titled <a href="https://www.youtube.com/watch?v=qtS6NBobtnc">Pi in the Sky: Onboarding Edge Workloads Into the Service Mesh!</a> and we onboarded a bare-metal Raspberry Pi into the Istio mesh by running the ambient ztunnel directly on the Pi.</p>

<p>We only had thirty minutes to give our lightning talk so some of our demo needed to be cut. One of those demos was our mTLS secured teapot onboarded onto the mesh.</p>

<p>As part of our demo, we use a <a href="https://msnswitch.com/">MSNSwitch</a> to control outlets remotely. This part was honestly a little hacky because I ended up not being able to get the secure requests to work over the MSNSwitch apis, so I ended up having to inspect the MSNSwitch source code to figure out how requests on the admin panel were being made. Then I scrapped the cookie from the login page and made the call directly with the cookie in the header like you see on the GitHub <a href="https://github.com/npolshakova/KubeconDemos/blob/main/msn_switch_server/switch_app.py#L22">source code</a>.</p>

<p>Then I wrapped all of the MSNSwitch APIs with a simple Flask webserver. I ran the server on the Raspberry Pi that was connected to the MSNSwitch:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>python3 ./msn_switch_server/switch_app.py 
</code></pre></div></div>

<p>This has serveral paths:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>switchOne/on
switchOne/off 
switchOne/toggle
switchTwo/on
switchTwo/off 
switchTwo/toggle
</code></pre></div></div>

<p>This will run on port <code class="language-plaintext highlighter-rouge">80</code> and will be reachable via:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://&lt;raspberry-pi&gt;:80/switchTwo/on
</code></pre></div></div>

<p>On the cluster side, I needed to create a Kubernetes service that we could use to apply Istio policies to:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply -f - &lt;&lt;EOF
apiVersion: v1
kind: Service
metadata:
  name: teapot-pi
  namespace: pi-namespace
  labels:
    app: teapot-pi
spec:
  ports:
  - port: 80
    name: http-pi
    targetPort: 80
  selector:
    app: "${PI_APP}"
EOF
</code></pre></div></div>

<p>Now for the fun Istio part- we want to define the <code class="language-plaintext highlighter-rouge">418</code> status code without implementing HTCPCP. Istio’s <a href="https://istio.io/latest/docs/reference/config/networking/virtual-service/">VirtualServices</a> defines a set of traffic routing rules and configuration to apply when a host is addressed. One of the configurations a user can make is adding <a href="https://istio.io/latest/docs/reference/config/networking/virtual-service/#HTTPFaultInjection">HTTPFaultInjection</a> to test the resiliency of a system to certain failure codes.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: teapot-app-fault-injection
  namespace: pi-namespace
spec:
  exportTo: 
  - "*"
  hosts:
  - teapot-pi
  http:
  - match:
    - headers:
        tea-drinker:
          exact: nina
    headers:
     response:
      add:
       test: "I'm a teapot!"
    fault:
     abort:
        httpStatus: 418
        percentage:
          value: 100
    route:
    - destination:
        host: teapot-pi
        port:
          number: 80
</code></pre></div></div>

<p>In this example we’ll also add some <a href="https://istio.io/latest/docs/reference/config/networking/virtual-service/#Headers">header manipulation</a> to injection a simple “test: I’m a teapot!” header. Both the header manipulation and fault injection is only triggered when the <code class="language-plaintext highlighter-rouge">tea-drinker: nina</code> header is provided. All other requests will go through as expected.</p>

<p>I applied this policy with <code class="language-plaintext highlighter-rouge">kubectl apply</code> in the namespace the Kubernetes service is defined in.</p>

<p>Finally I could curl with this and turn on the teapot:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl teapot-pi.pi-namespace:80/switchTwo/on
</code></pre></div></div>

<p>However, adding the <code class="language-plaintext highlighter-rouge">-H "tea-drinker: nina"</code> header results in a fault injection with the <code class="language-plaintext highlighter-rouge">418</code> status:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -H "tea-drinker: nina" teapot-pi.pi-namespace:80/switchOne/on -v 
</code></pre></div></div>

<p><strong>1/31/2024 Update!</strong>*</p>

<p>I finally got a chance to show my ✨ambient✨ teapot in action with Peter in Solo.io’s weekly <a href="https://www.youtube.com/watch?v=fa_1eRYdLDI">Hoot webinar</a>!</p>

    
  </div>
</article>

<div class="related">
  <h3>Other posts</h3>
  <ul class="related-posts">
    
      <li>
        <h5>
          <a href="/2024/01/14/kubectl.html">
            Kubectl
            <small>14 Jan 2024</small>
          </a>
        </h5>
      </li>
    
      <li>
        <h5>
          <a href="/2023/12/26/recap.html">
            Looking back on a busy 2023
            <small>26 Dec 2023</small>
          </a>
        </h5>
      </li>
    
  </ul>
</div>

    </div>
  </div>

  <label for="sidebar-checkbox" class="sidebar-toggle"><i class="fa fa-bars"></i></label>

<script defer src="https://use.fontawesome.com/releases/v5.0.2/js/all.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.0.0/anchor.min.js"></script>
<script type="text/javascript">
  anchors.options.placement = 'left';
  anchors.add('h2');
</script>
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', '', 'auto');
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
</script>


</body>
</html>
